{% extends "base.html" %}

{% block title %}ì‹¤ì‹œê°„ í† ë§ˆí†  ëª¨ë‹ˆí„°ë§{% endblock %}

{% block head_extra %}
<style>
  /* ê¸°ë³¸ í°íŠ¸ ë° ë°°ê²½ ì„¤ì • */
  body {
    font-family: 'Noto Sans KR', sans-serif;
    background-color: #fafafa;
    margin: 0;
    padding: 0;
    color: #333;
  }
  header {
    background-color: #2b7a0b;
    color: #fff;
    padding: 1rem 2rem;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
    color: #fff;
  }
  header .logout-btn {
    position: absolute;
    top: 50%;
    right: 2rem;
    transform: translateY(-50%);
  }
  header .logout-btn a {
    color: #fff;
    text-decoration: none;
    font-size: 0.9rem;
    border: 1px solid #fff;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
  }

  .container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    padding: 2rem;
    gap: 2rem;
  }

  .video-container {
    position: relative;
    background-color: #000;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  .video-container img {
    display: block;
    max-width: 100%;
    height: auto;
  }
  .fps-label {
    position: absolute;
    top: 8px;
    left: 8px;
    background-color: rgba(0, 0, 0, 0.6);
    color: #fff;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.9rem;
    z-index: 10;
  }

  .detection-list {
    width: 320px;
    max-height: 480px;
    overflow-y: auto;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 1rem;
  }
  .detection-list h2 {
    margin-top: 0;
    font-size: 1.2rem;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 0.5rem;
  }
  .detection-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .detection-list ul li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.95rem;
  }
  .detection-list ul li:last-child {
    border-bottom: none;
  }
  .detection-list ul li span:first-child {
    font-weight: bold;
    color: #2b7a0b;
    margin-right: 0.5rem;
  }
  .detection-list ul li span:last-child {
    font-size: 0.9rem;
    color: #555;
  }

  /* ì„¼ì„œ ìƒíƒœ í‘œì‹œ ì „ìš© ìŠ¤íƒ€ì¼ */
  .sensor-list {
    width: 320px;
    max-height: 480px;
    overflow-y: auto;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 1rem;
  }
  .sensor-list h2 {
    margin-top: 0;
    font-size: 1.2rem;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 0.5rem;
  }
  .sensor-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .sensor-list ul li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.95rem;
  }
  .sensor-list ul li:last-child {
    border-bottom: none;
  }
  .sensor-list ul li span:first-child {
    font-weight: bold;
    color: #2b7a0b;
    margin-right: 0.5rem;
  }
  .sensor-list ul li span:last-child {
    font-size: 0.9rem;
    color: #555;
  }
</style>
{% endblock %}

{% block content %}
  <!-- ìƒë‹¨ í—¤ë” -->
  <header>
    <h1>ğŸŒ± ì‹ë¬¼ ì„±ì¥Â·ì»¨ë””ì…˜ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>
    <div class="logout-btn">
      <a href="{{ url_for('logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
  </header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="container">
    <!-- ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì˜ì—­ -->
    <div class="video-container">
      <div id="fps" class="fps-label">FPS: --</div>
      <img id="video-stream" src="{{ url_for('video_feed') }}" alt="ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°" />
    </div>

    <!-- 10ì´ˆ ê°„ê²© ì €ì¥ëœ ê°ì§€ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ -->
    <div class="detection-list">
      <h2>ìµœê·¼ ê°ì§€ ë‚´ì—­</h2>
      <ul id="detection-items">
        <!-- JavaScriptê°€ ë°ì´í„°ë¥¼ ì±„ì›ë‹ˆë‹¤ -->
      </ul>
    </div>

    <!-- ì„¼ì„œ ìƒíƒœ í‘œì‹œ íŒ¨ë„ -->
    <div class="sensor-list">
      <h2>ì‹¤ì‹œê°„ ì„¼ì„œ ìƒíƒœ</h2>
      <ul id="sensor-items">
        <li>
          <span>ì˜¨ë„</span>
          <span id="temp-val">â€“</span>
        </li>
        <li>
          <span>ìŠµë„</span>
          <span id="hum-val">â€“</span>
        </li>
        <li>
          <span>ì¡°ë„</span>
          <span id="lux-val">â€“</span>
        </li>
        <li>
          <span>ìˆ˜ìœ„</span>
          <span id="water-val">â€“</span>
        </li>
        <li>
          <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</span>
          <span id="time-val">â€“</span>
        </li>
      </ul>
    </div>
  </div>

  <!-- JavaScript: FPS ê³„ì‚°, ê°ì§€ ê¸°ë¡ ë° ì„¼ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° -->
  <script>
    // ===== FPS ê³„ì‚° =====
    let lastTime = performance.now();
    let frameCount = 0;
    function updateFPS() {
      frameCount++;
      const now = performance.now();
      if (now - lastTime >= 1000) {
        const fps = frameCount / ((now - lastTime) / 1000);
        document.getElementById("fps").innerText = "FPS: " + fps.toFixed(1);
        lastTime = now;
        frameCount = 0;
      }
      requestAnimationFrame(updateFPS);
    }
    const videoImg = document.getElementById("video-stream");
    videoImg.onload = () => {
      frameCount++;
    };

    // ===== ê°ì§€ ë°ì´í„°(fetch /data) =====
    async function fetchDetectionData() {
      try {
        const resp = await fetch("/data");
        const history = await resp.json();
        const ul = document.getElementById("detection-items");
        ul.innerHTML = "";

        history.forEach(item => {
          const li = document.createElement("li");

          // íƒ€ì„ìŠ¤íƒ¬í”„
          const timeSpan = document.createElement("span");
          timeSpan.textContent = item.timestamp;

          // ìƒíƒœ ë¬¸ìì—´ ìƒì„±
          const statusSpan = document.createElement("span");
          const growthText = (item.growth_label !== null) ? item.growth_label : "None";
          let conditionText;
          if (item.condition_label === "tomato_blight") {
            conditionText = "ë³‘ì¶©í•´";
          } else {
            conditionText = "None";
          }
          statusSpan.textContent = `ì„±ì¥:${growthText} | ìƒíƒœ:${conditionText}`;

          li.appendChild(timeSpan);
          li.appendChild(statusSpan);
          ul.appendChild(li);
        });
      } catch (e) {
        console.error("ê°ì§€ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
      }
    }

    // ===== ì„¼ì„œ ë°ì´í„°(fetch /sensor_status) =====
    let lastTimestamp = null;
    async function fetchSensorData() {
      try {
        const res = await fetch('/sensor_status');
        if (!res.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
        const data = await res.json();
        // ìƒˆë¡œìš´ last_updateê°€ ì´ì „ê³¼ ë‹¤ë¥´ë©´ í™”ë©´ ê°±ì‹ 
        if (data.last_update && data.last_update !== lastTimestamp) {
          lastTimestamp = data.last_update;
          document.getElementById('temp-val').textContent =
            data.temperature !== null ? data.temperature.toFixed(1) + 'Â°C' : 'ì¸¡ì • ì‹¤íŒ¨';
          document.getElementById('hum-val').textContent =
            data.humidity !== null ? data.humidity.toFixed(1) + '%' : 'ì¸¡ì • ì‹¤íŒ¨';
          document.getElementById('lux-val').textContent =
            data.lux !== null ? data.lux.toFixed(0) + ' lux' : 'ì¸¡ì • ì‹¤íŒ¨';
          document.getElementById('water-val').textContent =
            data.water_detected === true  ? 'ë¬¼ ê³ ì„(HIGH)' :
            data.water_detected === false ? 'ì •ìƒ(LOW)'   :
            'ì¸¡ì • ì‹¤íŒ¨';
          document.getElementById('time-val').textContent = data.last_update;
        }
        // last_updateê°€ ë™ì¼í•˜ë©´ ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ (ì´ì „ ê°’ì„ ê·¸ëŒ€ë¡œ ìœ ì§€)
      } catch (err) {
        console.error('ì„¼ì„œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    }

    // ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë° ì£¼ê¸°ì  ê°±ì‹  =====
    window.addEventListener("DOMContentLoaded", () => {
      requestAnimationFrame(updateFPS);
      fetchDetectionData();
      fetchSensorData();
      setInterval(fetchDetectionData, 5000);  // 5ì´ˆë§ˆë‹¤ ê°ì§€ ë°ì´í„° ê°±ì‹ 
      setInterval(fetchSensorData, 2000);     // 2ì´ˆë§ˆë‹¤ ì„¼ì„œ ë°ì´í„° í™•ì¸
    });
  </script>
{% endblock %}
